<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Analysis Report</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'mono': ['Monaco', 'Menlo', 'Ubuntu Mono', 'monospace']
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
{{.JSBundle}}
    </script>
        
        function MediaAnalysisReport() {
            const [data, setData] = useState({ mediaFiles: [], totalFiles: 0, generatedAt: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
            const [showRelativePaths, setShowRelativePaths] = useState(false);
            const [columnVisibility, setColumnVisibility] = useState({
                file: true,
                size: true,
                duration: true,
                videoCodec: true,
                bitrate: true,
                resolution: true,
                audioTracks: true,
                subtitleTracks: true
            });
            const [showColumnMenu, setShowColumnMenu] = useState(false);
            
            useEffect(() => {
                const jsonData = document.getElementById('media-data').textContent;
                const parsedData = JSON.parse(jsonData);
                setData(parsedData);
            }, []);
            
            const formatFileSize = (bytes) => {
                return (bytes / (1024 * 1024)).toFixed(1);
            };
            
            const formatDuration = (seconds) => {
                return (seconds / 60).toFixed(1);
            };
            
            const getDisplayPath = (fullPath) => {
                if (showRelativePaths) {
                    // Extract relative path from the full path
                    const pathParts = fullPath.split('/');
                    const inputDirIndex = pathParts.findIndex(part => part.includes('jpguide') || part.includes('snw-season-1'));
                    if (inputDirIndex !== -1) {
                        return pathParts.slice(inputDirIndex).join('/');
                    }
                }
                // Return just filename
                return fullPath.split('/').pop();
            };
            
            const filteredAndSortedData = useMemo(() => {
                let filtered = data.mediaFiles.filter(item => {
                    const searchLower = searchTerm.toLowerCase();
                    return (
                        item.file_path.toLowerCase().includes(searchLower) ||
                        item.video_codec.toLowerCase().includes(searchLower)
                    );
                });
                
                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        let aVal, bVal;
                        
                        switch (sortConfig.key) {
                            case 'file':
                                aVal = getDisplayPath(a.file_path);
                                bVal = getDisplayPath(b.file_path);
                                break;
                            case 'size':
                                aVal = a.file_size;
                                bVal = b.file_size;
                                break;
                            case 'duration':
                                aVal = a.duration;
                                bVal = b.duration;
                                break;
                            case 'videoCodec':
                                aVal = a.video_codec;
                                bVal = b.video_codec;
                                break;
                            case 'bitrate':
                                aVal = a.video_bitrate;
                                bVal = b.video_bitrate;
                                break;
                            case 'resolution':
                                aVal = a.video_width * a.video_height;
                                bVal = b.video_width * b.video_height;
                                break;
                            case 'audioTracks':
                                aVal = a.audio_tracks.length;
                                bVal = b.audio_tracks.length;
                                break;
                            case 'subtitleTracks':
                                aVal = a.subtitle_tracks.length;
                                bVal = b.subtitle_tracks.length;
                                break;
                            default:
                                return 0;
                        }
                        
                        if (typeof aVal === 'string') {
                            const result = aVal.localeCompare(bVal);
                            return sortConfig.direction === 'asc' ? result : -result;
                        } else {
                            const result = aVal - bVal;
                            return sortConfig.direction === 'asc' ? result : -result;
                        }
                    });
                }
                
                return filtered;
            }, [data.mediaFiles, searchTerm, sortConfig, showRelativePaths]);
            
            const handleSort = (key) => {
                setSortConfig(prevConfig => ({
                    key,
                    direction: prevConfig.key === key && prevConfig.direction === 'asc' ? 'desc' : 'asc'
                }));
            };
            
            const getSortIcon = (columnKey) => {
                if (sortConfig.key === columnKey) {
                    return sortConfig.direction === 'asc' ? ' ↑' : ' ↓';
                }
                return ' ↕';
            };
            
            const toggleColumnVisibility = (column) => {
                setColumnVisibility(prev => ({
                    ...prev,
                    [column]: !prev[column]
                }));
            };
            
            const totalSize = data.mediaFiles.reduce((sum, item) => sum + item.file_size, 0);
            const totalDuration = data.mediaFiles.reduce((sum, item) => sum + item.duration, 0);
            
            const codecCounts = data.mediaFiles.reduce((acc, item) => {
                acc[item.video_codec] = (acc[item.video_codec] || 0) + 1;
                return acc;
            }, {});
            
            return (
                <div className="min-h-screen bg-gray-50 py-8">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="bg-white shadow-xl rounded-lg overflow-hidden">
                            <div className="px-6 py-8 border-b border-gray-200">
                                <h1 className="text-3xl font-bold text-gray-900 text-center mb-6">
                                    Media Analysis Report
                                </h1>
                                
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                    <div className="bg-blue-50 rounded-lg p-4 text-center">
                                        <div className="text-2xl font-bold text-blue-600">{data.totalFiles}</div>
                                        <div className="text-sm text-gray-600">Total Files</div>
                                    </div>
                                    <div className="bg-green-50 rounded-lg p-4 text-center">
                                        <div className="text-2xl font-bold text-green-600">
                                            {(totalSize / (1024 * 1024 * 1024)).toFixed(1)} GB
                                        </div>
                                        <div className="text-sm text-gray-600">Total Size</div>
                                    </div>
                                    <div className="bg-purple-50 rounded-lg p-4 text-center">
                                        <div className="text-2xl font-bold text-purple-600">
                                            {(totalDuration / 3600).toFixed(1)} hrs
                                        </div>
                                        <div className="text-sm text-gray-600">Total Duration</div>
                                    </div>
                                </div>
                                
                                <div className="bg-gray-50 rounded-lg p-4 mb-6">
                                    <h3 className="text-sm font-medium text-gray-700 mb-2">Video Codecs</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {Object.entries(codecCounts).map(([codec, count]) => (
                                            <span key={codec} className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                {codec}: {count} files
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="px-6 py-4 bg-gray-50 border-b border-gray-200">
                                <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                                    <div className="flex-1 max-w-md">
                                        <input
                                            type="text"
                                            placeholder="Search files..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    
                                    <div className="flex flex-col sm:flex-row gap-4">
                                        <label className="flex items-center">
                                            <input
                                                type="checkbox"
                                                checked={showRelativePaths}
                                                onChange={(e) => setShowRelativePaths(e.target.checked)}
                                                className="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                            />
                                            <span className="text-sm text-gray-700">Show relative paths</span>
                                        </label>
                                        
                                        <div className="relative">
                                            <button
                                                onClick={() => setShowColumnMenu(!showColumnMenu)}
                                                className="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                Columns ▼
                                            </button>
                                            
                                            {showColumnMenu && (
                                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 z-10">
                                                    <div className="py-1">
                                                        {Object.entries(columnVisibility).map(([column, visible]) => (
                                                            <label key={column} className="flex items-center px-4 py-2 hover:bg-gray-50">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={visible}
                                                                    onChange={() => toggleColumnVisibility(column)}
                                                                    className="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                                />
                                                                <span className="text-sm text-gray-700 capitalize">
                                                                    {column.replace(/([A-Z])/g, ' $1').trim()}
                                                                </span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            {columnVisibility.file && (
                                                <th
                                                    onClick={() => handleSort('file')}
                                                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                                                >
                                                    File{getSortIcon('file')}
                                                </th>
                                            )}
                                            {columnVisibility.size && (
                                                <th
                                                    onClick={() => handleSort('size')}
                                                    className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                                                >
                                                    Size (MB){getSortIcon('size')}
                                                </th>
                                            )}
                                            {columnVisibility.duration && (
                                                <th
                                                    onClick={() => handleSort('duration')}
                                                    className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                                                >
                                                    Duration (min){getSortIcon('duration')}
                                                </th>
                                            )}
                                            {columnVisibility.videoCodec && (
                                                <th
                                                    onClick={() => handleSort('videoCodec')}
                                                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                                                >
                                                    Video Codec{getSortIcon('videoCodec')}
                                                </th>
                                            )}
                                            {columnVisibility.bitrate && (
                                                <th
                                                    onClick={() => handleSort('bitrate')}
                                                    className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                                                >
                                                    Bitrate (kbps){getSortIcon('bitrate')}
                                                </th>
                                            )}
                                            {columnVisibility.resolution && (
                                                <th
                                                    onClick={() => handleSort('resolution')}
                                                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                                                >
                                                    Resolution{getSortIcon('resolution')}
                                                </th>
                                            )}
                                            {columnVisibility.audioTracks && (
                                                <th
                                                    onClick={() => handleSort('audioTracks')}
                                                    className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                                                >
                                                    Audio{getSortIcon('audioTracks')}
                                                </th>
                                            )}
                                            {columnVisibility.subtitleTracks && (
                                                <th
                                                    onClick={() => handleSort('subtitleTracks')}
                                                    className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                                                >
                                                    Subtitles{getSortIcon('subtitleTracks')}
                                                </th>
                                            )}
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {filteredAndSortedData.map((item, index) => (
                                            <tr key={index} className="hover:bg-gray-50">
                                                {columnVisibility.file && (
                                                    <td className="px-6 py-4 text-sm text-gray-900 font-mono max-w-xs truncate" title={item.file_path}>
                                                        {getDisplayPath(item.file_path)}
                                                    </td>
                                                )}
                                                {columnVisibility.size && (
                                                    <td className="px-6 py-4 text-sm text-gray-900 text-right">
                                                        {formatFileSize(item.file_size)}
                                                    </td>
                                                )}
                                                {columnVisibility.duration && (
                                                    <td className="px-6 py-4 text-sm text-gray-900 text-right">
                                                        {formatDuration(item.duration)}
                                                    </td>
                                                )}
                                                {columnVisibility.videoCodec && (
                                                    <td className="px-6 py-4 text-sm text-gray-900">
                                                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                            {item.video_codec}
                                                        </span>
                                                    </td>
                                                )}
                                                {columnVisibility.bitrate && (
                                                    <td className="px-6 py-4 text-sm text-gray-900 text-right">
                                                        {Math.round(item.video_bitrate / 1000)}
                                                    </td>
                                                )}
                                                {columnVisibility.resolution && (
                                                    <td className="px-6 py-4 text-sm text-gray-900">
                                                        {item.video_width}×{item.video_height}
                                                    </td>
                                                )}
                                                {columnVisibility.audioTracks && (
                                                    <td className="px-6 py-4 text-sm text-gray-900 text-right">
                                                        {item.audio_tracks.length}
                                                    </td>
                                                )}
                                                {columnVisibility.subtitleTracks && (
                                                    <td className="px-6 py-4 text-sm text-gray-900 text-right">
                                                        {item.subtitle_tracks.length}
                                                    </td>
                                                )}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                
                                {filteredAndSortedData.length === 0 && (
                                    <div className="text-center py-12">
                                        <div className="text-gray-500">No files match your search criteria.</div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="px-6 py-4 bg-gray-50 border-t border-gray-200">
                                <div className="text-sm text-gray-500 text-center">
                                    Generated on {new Date(data.generatedAt).toLocaleString()} • 
                                    Showing {filteredAndSortedData.length} of {data.totalFiles} files
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // Click outside to close column menu
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                // This is a simple way to close dropdowns, in a real app you'd use refs
            }
        });
        
        ReactDOM.render(<MediaAnalysisReport />, document.getElementById('root'));
    </script>
</body>
</html>